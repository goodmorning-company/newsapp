// firestore.rules
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isEditor() {
      return request.auth != null && request.auth.token.editor == true;
    }

    function isNonEmptyString(value, min, max) {
      return value is string && value.size() >= min && value.size() <= max;
    }

    function isOptionalString(value, min, max) {
      return value == null || (value is string && value.size() >= min && value.size() <= max);
    }

    function validAuthor(author) {
      return author is map
        && isNonEmptyString(author.id, 1, 80)
        && isNonEmptyString(author.name, 1, 120)
        && isOptionalString(author.bio, 0, 500)
        && isOptionalString(author.avatarUrl, 0, 500);
    }

    function validTags(tags) {
      return tags is list
        && tags.size() <= 10;
    }

    function validArticle(data) {
      return isNonEmptyString(data.title, 4, 140)
        && isOptionalString(data.subtitle, 0, 200)
        && isNonEmptyString(data.summary, 10, 400)
        && isNonEmptyString(data.body, 50, 50000)
        && data.publishedAt is timestamp
        && data.updatedAt is timestamp
        && validAuthor(data.author)
        && validTags(data.tags)
        && (data.coverImageUrl == null || isNonEmptyString(data.coverImageUrl, 1, 500))
        && data.readingTimeMinutes is int
        && data.readingTimeMinutes >= 1
        && data.readingTimeMinutes <= 60;
    }

    match /articles/{articleId} {
      allow read: if true; // public reads allowed
      allow create, update: if isEditor() && validArticle(request.resource.data);
      allow delete: if false; // disallow deletes by default
    }

    // Deny everything else by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
